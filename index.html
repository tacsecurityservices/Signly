<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signly</title>
     <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%234F46E5%22 /><text x=%2250%22 y=%2275%22 font-size=%2250%22 font-family=%22sans-serif%22 font-weight=%22bold%22 text-anchor=%22middle%22 fill=%22%23FFFFFF%22>S</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- We use html2pdf.js to handle the PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Lucide icons for a cleaner UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styles specifically for printing to PDF */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
            }
            /* Hide UI elements that shouldn't be in the PDF */
            .print\:hidden,
            #upload-controls,
            .remove-item-btn,
            .toggle-amount-lock-btn {
                display: none !important;
            }
            .invoice-container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                font-size: 12px; /* Smaller base font for the PDF */
            }
            h2.text-4xl {
                font-size: 24px; /* Adjusting heading size for PDF */
            }
            input, textarea {
                border: none !important;
                outline: none !important;
                background-color: transparent !important;
                padding: 0 !important;
            }
            .signature-line {
                border-bottom: 1px solid #000 !important;
            }
            /* Adjusting spacing and fonts for a compact PDF layout */
            .mb-10 { margin-bottom: 2rem !important; }
            .mb-8 { margin-bottom: 1.5rem !important; }
            .mb-4 { margin-bottom: 1rem !important; }
            .mb-2 { margin-bottom: 0.5rem !important; }
            .py-2 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
            .text-sm { font-size: 12px !important; }
            .text-xs { font-size: 10px !important; }
            #invoice-container input, #invoice-container textarea {
                font-size: 12px !important;
                line-height: 1.2 !important;
                min-height: 1.2rem !important;
            }
            #line-items-container .flex {
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 print:hidden">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 md:mb-0">Signly</h1>
            <div class="flex flex-wrap items-center justify-center gap-2">
                <button id="new-invoice-btn" class="flex-1 min-w-[120px] items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    <i data-lucide="file-text" class="h-5 w-5"></i>
                    <span>Invoice</span>
                </button>
                <button id="new-po-btn" class="flex-1 min-w-[120px] items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    <i data-lucide="file-plus" class="h-5 w-5"></i>
                    <span>PO</span>
                </button>
                <button id="new-dn-btn" class="flex-1 min-w-[120px] items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    <i data-lucide="package" class="h-5 w-5"></i>
                    <span>DN</span>
                </button>
            </div>
        </header>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-2 justify-center mb-8 print:hidden">
            <button id="toggle-saved-list-btn" class="flex-1 min-w-[150px] items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200">
                <span>View Saved Documents</span>
            </button>
            <button id="save-document-btn" class="flex-1 min-w-[150px] items-center justify-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200">
                <i data-lucide="save" class="h-5 w-5"></i>
                <span>Save Document</span>
            </button>
            <button id="export-pdf-btn" class="flex-1 min-w-[150px] items-center justify-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-200">
                <i data-lucide="file-down" class="h-5 w-5"></i>
                <span>Download</span>
            </button>
        </div>
        
        <!-- Saved Documents List -->
        <div id="saved-documents-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 print:hidden hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Saved Documents</h2>
            <div id="saved-list">
                <p class="text-gray-500">No documents saved yet.</p>
            </div>
        </div>

        <!-- Invoice Container -->
        <div id="invoice-container" class="bg-white p-6 md:p-12 rounded-xl shadow-lg border border-gray-200">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start mb-10">
                <div class="mb-6 md:mb-0">
                    <!-- A container for the logo and its upload controls -->
                    <div id="logo-section">
                        <!-- Added an attribute to easily identify the placeholder image -->
                        <img id="logo-preview" data-placeholder src="https://placehold.co/192x96/e5e7eb/6b7280?text=Upload+Logo" alt="Business Logo" class="w-full sm:w-auto max-w-[192px] h-auto max-h-24 object-contain mb-4 rounded-md" />
                        <!-- Logo upload input, hidden on print -->
                        <div id="upload-controls" class="print:hidden">
                            <label for="logo-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload Logo</label>
                            <input
                                type="file"
                                id="logo-upload"
                                accept="image/*"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"
                            />
                        </div>
                    </div>
                </div>
                <div class="text-right flex-grow">
                    <h2 id="document-type-heading" class="text-4xl font-extrabold text-indigo-700 uppercase">Invoice</h2>
                    <div class="mt-2 text-sm text-gray-500">
                        <p id="document-number-label">Invoice # <input type="text" id="document-number-input" class="w-32 inline-block bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1" /></p>
                        <p>Date: <input type="date" id="document-date-input" class="w-32 inline-block bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1" /></p>
                        <p>Due Date: <input type="date" id="due-date-input" class="w-32 inline-block bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1" /></p>
                    </div>
                </div>
            </div>

            <!-- Business and Client Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">From:</h3>
                    <div class="flex flex-col space-y-1">
                        <input type="text" id="company-name-input" class="font-bold bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-base" />
                        <textarea id="company-address-input" class="bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-sm resize-none" rows="2"></textarea>
                        <input type="text" id="company-phone-input" class="bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-sm" />
                        <input type="text" id="company-email-input" class="bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-sm" />
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">To:</h3>
                    <div class="flex flex-col space-y-1">
                        <input type="text" id="client-name-input" class="font-bold bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-base" />
                        <textarea id="client-address-input" class="bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-sm resize-none" rows="2"></textarea>
                        <input type="text" id="client-email-input" class="bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1 text-sm" />
                    </div>
                </div>
            </div>

            <!-- Line Items Table -->
            <div class="mb-10">
                <!-- Table Header - Visible on medium screens and up -->
                <div class="hidden md:flex items-center text-sm font-semibold text-gray-600 uppercase mb-2">
                    <div class="w-1/2">Description</div>
                    <div class="w-1/6 text-center">Quantity</div>
                    <div class="w-1/6 text-right">Rate</div>
                    <div class="w-1/6 text-right">Amount</div>
                    <div class="w-6 print:hidden"></div>
                </div>
                <!-- The container for line items. The items themselves will handle their own responsiveness. -->
                <div id="line-items-container">
                    <!-- Line items will be injected here -->
                </div>
                <div class="print:hidden mt-4">
                    <button id="add-item-btn" class="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-200 text-sm font-semibold">
                        <i data-lucide="plus" class="h-4 w-4"></i>
                        <span>Add Item</span>
                    </button>
                </div>
            </div>

            <!-- Totals Section -->
            <div class="flex justify-end mt-8">
                <div class="w-full md:w-1/2">
                    <div class="flex justify-between border-t border-gray-200 pt-4">
                        <span class="text-lg font-semibold text-gray-700">Subtotal:</span>
                        <span class="text-lg font-bold text-gray-900" id="subtotal-amount">R 0.00</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="text-xl font-bold text-indigo-700">Total:</span>
                        <span class="text-xl font-bold text-indigo-700" id="total-amount">R 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="mt-16 pt-8 border-t border-gray-200 flex flex-col md:flex-row justify-between gap-8">
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Sender's Signature</p>
                    <div class="signature-line w-full h-px bg-gray-300 mb-10"></div>
                    <input type="text" placeholder="Print Name" class="w-full text-sm bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1" />
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Receiver's Signature</p>
                    <div class="signature-line w-full h-px bg-gray-300 mb-10"></div>
                    <input type="text" placeholder="Print Name" class="w-full text-sm bg-transparent border-b border-gray-300 focus:outline-none focus:border-indigo-500 p-1" />
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer Section -->
    <footer class="bg-gray-200 p-4 mt-8 text-center text-sm text-gray-600 print:hidden">
        <p>&copy; 2025 Developed By Tac Cybersevices | Signly. All Rights Reserved.</p>
    </footer>

    <script>
        // Use lucide-icons for a clean look
        lucide.createIcons();

        // DOM elements
        const documentTypeHeading = document.getElementById('document-type-heading');
        const documentNumberLabel = document.getElementById('document-number-label');
        const documentNumberInput = document.getElementById('document-number-input');
        const documentDateInput = document.getElementById('document-date-input');
        const dueDateInput = document.getElementById('due-date-input');
        const companyNameInput = document.getElementById('company-name-input');
        const companyAddressInput = document.getElementById('company-address-input');
        const companyPhoneInput = document.getElementById('company-phone-input');
        const companyEmailInput = document.getElementById('company-email-input');
        const clientNameInput = document.getElementById('client-name-input');
        const clientAddressInput = document.getElementById('client-address-input');
        const clientEmailInput = document.getElementById('client-email-input');
        const logoUploadInput = document.getElementById('logo-upload');
        const logoPreview = document.getElementById('logo-preview');
        const uploadControls = document.getElementById('upload-controls');
        const lineItemsContainer = document.getElementById('line-items-container');
        const subtotalAmount = document.getElementById('subtotal-amount');
        const totalAmount = document.getElementById('total-amount');
        const toggleSavedListBtn = document.getElementById('toggle-saved-list-btn');
        const savedDocumentsContainer = document.getElementById('saved-documents-container');
        const savedList = document.getElementById('saved-list');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const PLACEHOLDER_LOGO_URL = 'https://placehold.co/192x96/e5e7eb/6b7280?text=Upload+Logo';

        // State variables
        let invoice = {
            documentType: 'Invoice',
            documentNumber: '',
            documentDate: new Date().toISOString().substring(0, 10),
            dueDate: '',
            companyName: 'Your Business Name',
            companyAddress: '123 Business St, City, State 12345',
            companyPhone: '123-456-7890',
            companyEmail: 'info@yourbusiness.com',
            clientName: 'Client Name',
            clientAddress: '456 Client Ave, City, State 67890',
            clientEmail: 'client@email.com',
            // Added isManualAmount and amount properties to each line item
            items: [{ id: Date.now(), description: '', quantity: 1, rate: 0, amount: 0, isManualAmount: false }],
            subtotal: 0,
            total: 0,
            logoUrl: null,
        };

        let savedDocuments = [];
        let documentCounters = {
            'Invoice': 0,
            'Purchase Order': 0,
            'Delivery Note': 0
        };

        // --- Document and Data Management Functions ---

        // Function to generate a chronological document number
        const generateDocumentNumber = (type) => {
            const prefixes = {
                'Invoice': 'INV-',
                'Purchase Order': 'PO-',
                'Delivery Note': 'DN-'
            };
            const prefix = prefixes[type];
            documentCounters[type]++;
            // Save the updated counters to local storage
            localStorage.setItem('documentCounters', JSON.stringify(documentCounters));
            return prefix + String(documentCounters[type]).padStart(4, '0');
        };

        // Function to render the line items in the table
        const renderLineItems = () => {
            lineItemsContainer.innerHTML = '';
            invoice.items.forEach(item => {
                const itemAmount = item.isManualAmount ? item.amount : (item.quantity * item.rate);
                const itemDiv = document.createElement('div');
                // The main change for mobile: use flex-col on small screens, then revert to flex-row on larger screens
                itemDiv.className = 'flex flex-col md:flex-row items-stretch md:items-center border-b border-gray-200 py-2 gap-2';
                itemDiv.innerHTML = `
                    <div class="md:w-1/2 w-full pr-2">
                        <label class="md:hidden block text-xs font-semibold text-gray-500 uppercase mb-1">Description</label>
                        <input type="text" value="${item.description}" class="w-full bg-transparent border-b border-gray-200 focus:outline-none focus:border-indigo-500 p-1 text-sm" placeholder="Item description" data-id="${item.id}" data-field="description" />
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div class="w-1/2 md:w-1/3">
                            <label class="md:hidden block text-xs font-semibold text-gray-500 uppercase mb-1">Qty</label>
                            <input type="number" value="${item.quantity}" class="w-full text-center bg-transparent border-b border-gray-200 focus:outline-none focus:border-indigo-500 p-1 text-sm" data-id="${item.id}" data-field="quantity" />
                        </div>
                        <div class="w-1/2 md:w-1/3">
                            <label class="md:hidden block text-xs font-semibold text-gray-500 uppercase mb-1">Rate</label>
                            <input type="number" value="${item.rate}" class="w-full text-right bg-transparent border-b border-gray-200 focus:outline-none focus:border-indigo-500 p-1 text-sm" data-id="${item.id}" data-field="rate" />
                        </div>
                        <!-- New manual amount field and toggle button -->
                        <div class="flex-1 w-full md:w-1/3 flex items-center gap-1">
                            <label class="md:hidden block text-xs font-semibold text-gray-500 uppercase mb-1 flex-1">Amount</label>
                            <input type="number" 
                                value="${itemAmount.toFixed(2)}" 
                                class="flex-1 w-full text-right bg-transparent border-b border-gray-200 focus:outline-none focus:border-indigo-500 p-1 text-sm ${!item.isManualAmount ? 'bg-gray-50 cursor-not-allowed' : ''}" 
                                data-id="${item.id}" 
                                data-field="amount" 
                                ${!item.isManualAmount ? 'readonly' : ''}
                            />
                            <button class="toggle-amount-lock-btn text-gray-500 hover:text-indigo-600 transition-colors shrink-0" data-id="${item.id}">
                                <i data-lucide="${item.isManualAmount ? 'lock' : 'calculator'}" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="md:w-6 flex justify-center self-center md:self-auto print:hidden">
                        <button class="text-red-500 hover:text-red-700 transition-colors remove-item-btn" data-id="${item.id}">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </div>
                `;
                lineItemsContainer.appendChild(itemDiv);
            });
            lucide.createIcons();
            addRemoveItemListeners();
            addItemChangeListeners();
            addToggleAmountLockListeners();
        };

        // Function to calculate and update totals
        const updateTotals = () => {
            const newSubtotal = invoice.items.reduce((acc, item) => {
                const itemAmount = item.isManualAmount ? item.amount : (item.quantity * item.rate);
                return acc + (parseFloat(itemAmount) || 0);
            }, 0);
            invoice.subtotal = newSubtotal;
            invoice.total = newSubtotal;
            subtotalAmount.textContent = `R ${newSubtotal.toFixed(2)}`;
            totalAmount.textContent = `R ${newSubtotal.toFixed(2)}`;
            saveToLocalStorage();
        };

        // Function to update the UI from the invoice state
        const updateUI = () => {
            documentTypeHeading.textContent = invoice.documentType;
            documentNumberLabel.textContent = `${invoice.documentType} #`;
            documentNumberInput.value = invoice.documentNumber;
            documentDateInput.value = invoice.documentDate;
            dueDateInput.value = invoice.dueDate;
            companyNameInput.value = invoice.companyName;
            companyAddressInput.value = invoice.companyAddress;
            companyPhoneInput.value = invoice.companyPhone;
            companyEmailInput.value = invoice.companyEmail;
            clientNameInput.value = invoice.clientName;
            clientAddressInput.value = invoice.clientAddress;
            clientEmailInput.value = invoice.clientEmail;
            if (invoice.logoUrl) {
                logoPreview.src = invoice.logoUrl;
                logoPreview.removeAttribute('data-placeholder'); // Remove the placeholder attribute when a logo is uploaded
                // Hide the upload controls when a logo is present
                uploadControls.classList.add('hidden');
            } else {
                logoPreview.src = PLACEHOLDER_LOGO_URL;
                logoPreview.setAttribute('data-placeholder', ''); // Add it back if no logo
                // Show the upload controls when there is no logo
                uploadControls.classList.remove('hidden');
            }
            renderLineItems();
            updateTotals();
        };

        // Function to save current invoice and counters to local storage
        const saveToLocalStorage = () => {
            localStorage.setItem('currentInvoice', JSON.stringify(invoice));
            localStorage.setItem('documentCounters', JSON.stringify(documentCounters));
            if (invoice.logoUrl) {
                localStorage.setItem('logoUrl', invoice.logoUrl);
            } else {
                localStorage.removeItem('logoUrl');
            }
        };

        // Function to load data from local storage
        const loadFromLocalStorage = () => {
            const storedInvoice = JSON.parse(localStorage.getItem('currentInvoice'));
            const storedLogoUrl = localStorage.getItem('logoUrl');
            const storedDocuments = JSON.parse(localStorage.getItem('savedDocuments'));
            const storedCounters = JSON.parse(localStorage.getItem('documentCounters'));
            
            if (storedInvoice) {
                invoice = storedInvoice;
            } else {
                invoice.documentNumber = generateDocumentNumber(invoice.documentType);
            }
            if (storedLogoUrl) {
                invoice.logoUrl = storedLogoUrl;
            }
            if (storedDocuments) {
                savedDocuments = storedDocuments;
            }
            if (storedCounters) {
                documentCounters = storedCounters;
            }
            updateUI();
            renderSavedDocuments();
        };

        // --- Event Listener Functions ---

        // Function to handle changes in line item inputs
        const addItemChangeListeners = () => {
            lineItemsContainer.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = e.target.value;

                    const item = invoice.items.find(i => i.id === id);
                    if (item) {
                        if (field === 'description') {
                            item[field] = value;
                        } else if (field === 'amount') {
                            // If amount is edited, set the manual flag to true
                            item.isManualAmount = true;
                            item.amount = parseFloat(value) || 0;
                        } else {
                            item[field] = parseFloat(value) || 0;
                            // If quantity or rate changes, revert to automatic calculation
                            item.isManualAmount = false;
                        }
                    }
                    renderLineItems();
                    updateTotals();
                });
            });
        };

        // Function to handle click on remove item buttons
        const addRemoveItemListeners = () => {
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    invoice.items = invoice.items.filter(item => item.id !== id);
                    renderLineItems();
                    updateTotals();
                });
            });
        };

        // Function to handle the toggle button for manual amount editing
        const addToggleAmountLockListeners = () => {
            document.querySelectorAll('.toggle-amount-lock-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    const item = invoice.items.find(i => i.id === id);
                    if (item) {
                        item.isManualAmount = !item.isManualAmount;
                        // If we are reverting to auto, update the amount
                        if (!item.isManualAmount) {
                            item.amount = item.quantity * item.rate;
                        }
                        renderLineItems();
                        updateTotals();
                    }
                });
            });
        };

        // Function to render the list of saved documents
        const renderSavedDocuments = () => {
            savedList.innerHTML = '';
            if (savedDocuments.length === 0) {
                savedList.innerHTML = '<p class="text-gray-500">No documents saved yet.</p>';
            } else {
                const ul = document.createElement('ul');
                ul.className = 'divide-y divide-gray-200';
                savedDocuments.forEach((doc, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between py-2';
                    li.innerHTML = `
                        <span class="font-medium">${doc.documentType} # ${doc.documentNumber}</span>
                        <span class="text-sm text-gray-500">${doc.documentDate} - Total: R ${doc.total.toFixed(2)}</span>
                        <button class="text-indigo-600 hover:text-indigo-800 transition-colors load-doc-btn" data-index="${index}">
                            Load
                        </button>
                    `;
                    ul.appendChild(li);
                });
                savedList.appendChild(ul);
                addLoadDocumentListeners();
            }
        };

        // Function to handle loading a saved document
        const addLoadDocumentListeners = () => {
            document.querySelectorAll('.load-doc-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    invoice = savedDocuments[index];
                    updateUI();
                    savedDocumentsContainer.classList.add('hidden');
                    toggleSavedListBtn.querySelector('span').textContent = 'View Saved Documents';
                });
            });
        };
        
        // --- Main Initialization and Event Handlers ---
        
        // Load data on page load
        window.onload = () => {
            loadFromLocalStorage();
        };

        document.getElementById('new-invoice-btn').addEventListener('click', () => {
            invoice.documentType = 'Invoice';
            invoice.documentNumber = generateDocumentNumber('Invoice');
            invoice.items = [{ id: Date.now(), description: '', quantity: 1, rate: 0, amount: 0, isManualAmount: false }];
            invoice.logoUrl = null;
            updateUI();
        });

        document.getElementById('new-po-btn').addEventListener('click', () => {
            invoice.documentType = 'Purchase Order';
            invoice.documentNumber = generateDocumentNumber('Purchase Order');
            invoice.items = [{ id: Date.now(), description: '', quantity: 1, rate: 0, amount: 0, isManualAmount: false }];
            invoice.logoUrl = null;
            updateUI();
        });

        document.getElementById('new-dn-btn').addEventListener('click', () => {
            invoice.documentType = 'Delivery Note';
            invoice.documentNumber = generateDocumentNumber('Delivery Note');
            invoice.items = [{ id: Date.now(), description: '', quantity: 1, rate: 0, amount: 0, isManualAmount: false }];
            invoice.logoUrl = null;
            updateUI();
        });

        document.getElementById('add-item-btn').addEventListener('click', () => {
            invoice.items.push({ id: Date.now(), description: '', quantity: 1, rate: 0, amount: 0, isManualAmount: false });
            renderLineItems();
            updateTotals();
        });

        document.getElementById('save-document-btn').addEventListener('click', () => {
            const documentToSave = { ...invoice, logoUrl: invoice.logoUrl };
            savedDocuments.push(documentToSave);
            localStorage.setItem('savedDocuments', JSON.stringify(savedDocuments));
            renderSavedDocuments();
            // Using a custom modal instead of alert()
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
                    <p class="text-lg font-semibold mb-4">${invoice.documentType} ${invoice.documentNumber} has been saved!</p>
                    <button id="close-modal-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        });

        toggleSavedListBtn.addEventListener('click', () => {
            savedDocumentsContainer.classList.toggle('hidden');
            const isHidden = savedDocumentsContainer.classList.contains('hidden');
            toggleSavedListBtn.querySelector('span').textContent = isHidden ? 'View Saved Documents' : 'Hide Saved Documents';
        });

        logoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    invoice.logoUrl = event.target.result;
                    updateUI(); // This will handle setting the logo and removing the placeholder attribute
                    saveToLocalStorage();
                };
                reader.readAsDataURL(file);
            }
        });
        
        // This is the new PDF generation logic
        exportPdfBtn.addEventListener('click', () => {
            const element = document.getElementById('invoice-container');
            const options = {
                margin: 10,
                filename: `${invoice.documentType}_${invoice.documentNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Check if the logo is the placeholder and hide elements
            const isPlaceholderLogo = logoPreview.getAttribute('data-placeholder') !== null;
            if (isPlaceholderLogo) {
                // We're using direct style manipulation for a more reliable hide/show
                uploadControls.style.display = 'none';
                logoPreview.style.display = 'none';
            }

            // Generate the PDF
            html2pdf().set(options).from(element).save().then(() => {
                // After the PDF is saved, remove the hide styles to make it visible again
                if (isPlaceholderLogo) {
                    uploadControls.style.display = '';
                    logoPreview.style.display = '';
                }
            });
        });

        // Event listeners for all form inputs
        [documentNumberInput, documentDateInput, dueDateInput, companyNameInput, companyAddressInput, companyPhoneInput, companyEmailInput, clientNameInput, clientAddressInput, clientEmailInput].forEach(input => {
            input.addEventListener('input', (e) => {
                const field = e.target.id.replace('-input', '');
                invoice[field] = e.target.value;
                saveToLocalStorage();
            });
        });
    </script>
</body>
</html>
